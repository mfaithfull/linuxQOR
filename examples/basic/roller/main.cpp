// Copyright Querysoft Limited 2008 - 2025
//
// Permission is hereby granted, free of charge, to any person or organization
// obtaining a copy of the software and accompanying documentation covered by
// this license (the "Software") to use, reproduce, display, distribute,
// execute, and transmit the Software, and to prepare derivative works of the
// Software, and to permit third-parties to whom the Software is furnished to
// do so, all subject to the following:
// 
// The copyright notices in the Software and this entire statement, including
// the above license grant, this restriction and the following disclaimer,
// must be included in all copies of the Software, in whole or in part, and
// all derivative works of the Software, unless such copies or derivative
// works are solely in the form of machine-executable object code generated by
// a source language processor.
// 
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT
// SHALL THE COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE
// FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN CONTRACT, TORT OR OTHERWISE,
// ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
// DEALINGS IN THE SOFTWARE.

//A documented application with a Role using the QOR SDK

/*For a more basic documented example of the flow of a QOR application
see the outline project*/

#include "sdk/using_framework.h"

#include "app.h"

/*QOR Applications each have a Role. The Role is a container of Features.
The Role manages the Setup and Shutdown of the Features*/

/*Here we include a custom Role class. This is not usually needed as the 
base Role class is usually sufficient*/
#include "customrole.h"

/*Here we incluse a custom Feature class. You can implement the features
of your application as custom QOR Features or just use the builtin ones
and add your own way manage custom functionality*/
#include "customfeature.h"

qor_pp_implement_module(App::Name)

/*To persude the linker to import what we need to use the ICurrentThread
interface we explcitly import the implementation
Note: If you ever get a - Template ID Factory cannot Construct an unregistered class
when you run your app, you may have missed one of these.
This is needed because ICurrentThread is platform specifc and has more than one
implementation*/
qor_pp_module_requires(ICurrentThread)

int main()
{
    /*We must request the AppBuilder to build a base Application class
    rather than our csutom derived App. 
    We've already redirected the factory so it will really give us a
    custom App instance. However we must always go through the 
    base Application singleton factory.
    Only ever do this in one translation unit (as this owns the factory)
    and use AppBuilder().TheApplication().AsRef<App>() to access
    your custom application in every case.*/
   return AppBuilder().Build<Application>(
        App::Name,
        [](ref_of<App>::type app)
        {   
            /*Here we can do early configuration of the App*/
            app->CustomConfigure();
        }
    )->SetRole<CustomRole>(
        /*The Build function gives us an App on which we can call SetRole with our Role class*/

        /*Whatever the type of your Role you'll always get an IRole interface on this customisation point*/
        [](ref_of<IRole>::type role)    
        {
            /*Here we configure the application Role by adding features
            We add a ThreadPool. A common features required by application roles*/
            role->AddFeature<ThreadPool>(

                /*Added features can be customised by passing a lamda
                as a customisation point just like for Applications and Roles*/
                [](ref_of<ThreadPool>::type threadPool)->void
                {
                    /*Customise the thread pool*/
                    threadPool->SetThreadCount(4);
                    /*Now we are going to have more than one thread showing up in the debugger
                    It's time to name the one we're running on now, to idenify it.*/
                    CurrentThread::Get().SetName("Main thread");
                }
            );

            /*You can add whatever Features you need including of course
            custom features*/
            role->AddFeature<CustomFeature>(
                /*These get customisation points just like builtin Featues*/
                [](ref_of<CustomFeature>::type customFeature)->void
                {
                    customFeature->DoThatConfigurationThing("Hello world.");
                }
            );
        }
    ).Run(

        make_runable(

            []()->int
            {
                /*The Application Role and Features are all shared objects
                so we need to access them with synchronisation. 
                Application is a singleton that is really our custom App class.
                The AppBuilder provides a way to get the instance from anywhere.
                We have to request conversion to a custom App reference
                Then get the Role and retrieve from it our CustomFeature by
                it's unique ID. We know it's real type so we can ask for the
                reference to be converted into a CustomFeature reference.
                Finally this gives us access to the SayHello function*/
                
                AppBuilder().TheApplication().//The Application is really the single App instance
                AsRef<App>(qor_shared)->//Converts the reference into an App reference
                GetRole(qor_shared)->//Get the IRole interface on the CustomRole instance
                GetFeature(&CustomFeatureGUID).//Lookup the CustomFeature by it's unique ID
                AsRef<CustomFeature>(qor_shared)->//Convert the reference from an IFeature to a CustomFeature
                SayHello();

                /*This is clearly massive overkill for a one line program but
                provides a structure to support large complex applications
                without forcing you to use all of it.*/

                return EXIT_SUCCESS;
            }
        )
    );
}