// Copyright Querysoft Limited 2008 - 2025
//
// Permission is hereby granted, free of charge, to any person or organization
// obtaining a copy of the software and accompanying documentation covered by
// this license (the "Software") to use, reproduce, display, distribute,
// execute, and transmit the Software, and to prepare derivative works of the
// Software, and to permit third-parties to whom the Software is furnished to
// do so, all subject to the following:
// 
// The copyright notices in the Software and this entire statement, including
// the above license grant, this restriction and the following disclaimer,
// must be included in all copies of the Software, in whole or in part, and
// all derivative works of the Software, unless such copies or derivative
// works are solely in the form of machine-executable object code generated by
// a source language processor.
// 
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT
// SHALL THE COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE
// FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN CONTRACT, TORT OR OTHERWISE,
// ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
// DEALINGS IN THE SOFTWARE.

#include "src/configuration/configuration.h"

#include "windowclassregistration.h"
#include "src/platform/os/windows/common/stringconv.h"
#include "src/platform/os/windows/api_layer/user/user32.h"

using namespace qor::nswindows::api;

namespace qor{ namespace platform { namespace nswindows{

    WindowClass::WindowClass()
    {
        m_style = 0;
        m_messageFunc = nullptr;
        m_classExtra = 0;
        m_windowExtra = 0;
    }

    unsigned int WindowClass::Style()
    {
        return m_style;
    }

    messageFunc WindowClass::WindowProc()
    {
        return m_messageFunc;
    }
    
    int WindowClass::ClassExtra()
    {
        return m_classExtra;
    }

    int WindowClass::WindowExtra()
    {
        return m_windowExtra;
    }

    const PrimitiveHandle& WindowClass::Instance()
    {
        return m_hInstance;
    }

    const Handle& WindowClass::Icon()
    {
        return m_hIcon;
    }
    
    const Handle& WindowClass::Cursor()
    {
        return m_hCursor;
    }

    const Handle& WindowClass::BackgroundBrush()
    {
        return m_hbrBackground;
    }

    const TCHAR* WindowClass::MenuName()
    {
        return m_menuName;
    }
    
    const TCHAR* WindowClass::Name()
    {
        return m_className;
    }

    const Handle& WindowClass::SmallIcon()
    {
        return m_hIconSm;
    }

    void WindowClass::SetStyle(int style)
    {
        m_style = style;
    }

    void WindowClass::SetMessageFunction(messageFunc f)
    {
        m_messageFunc = f;
    }

    void WindowClass::SetClassExtra(int extra)
    {
        m_classExtra = extra;
    }

    void WindowClass::SetWindowExtra(int extra)
    {
        m_windowExtra = extra;
    }

    void WindowClass::SetInstance(const PrimitiveHandle& hInstance)
    {
        m_hInstance = hInstance;
    }

    void WindowClass::SetIcon(const class Icon& icon)
    {
        m_hIcon = icon.GetHandle();
    }

    void WindowClass::SetSmallIcon(const class Icon& icon)
    {
        m_hIconSm = icon.GetHandle();
    }

    void WindowClass::SetCursor(const class Cursor& cursor)
    {
        m_hCursor = cursor.GetHandle();
    }

    void WindowClass::SetBackgroundBrush(const class Brush& brush)
    {
        m_hbrBackground = brush.GetHandle();
    }

    void WindowClass::SetMenuName(const TCHAR* menuName)
    {
        m_menuName = menuName;
    }

    void WindowClass::SetName(const TCHAR* name)
    {
        m_className = name;
    }

    WindowClassRegistration::WindowClassRegistration(WindowClass& windowClass) : m_windowClass(windowClass)
    {
        WNDCLASSEX wndClassEx;
        wndClassEx.cbSize = sizeof(WNDCLASSEX);            
        wndClassEx.style = windowClass.Style();
        wndClassEx.lpfnWndProc = (WNDPROC)windowClass.WindowProc();
        wndClassEx.cbClsExtra = windowClass.ClassExtra();
        wndClassEx.cbWndExtra = windowClass.WindowExtra();
        wndClassEx.hInstance = reinterpret_cast<HINSTANCE>(windowClass.Instance().Use());
        wndClassEx.hIcon = reinterpret_cast<HICON>(windowClass.Icon().Use());
        wndClassEx.hCursor = reinterpret_cast<HCURSOR>(windowClass.Cursor().Use());
        wndClassEx.hbrBackground = reinterpret_cast<HBRUSH>(windowClass.BackgroundBrush().Use());
        wndClassEx.lpszMenuName = windowClass.MenuName();
        wndClassEx.lpszClassName  = windowClass.Name();
        wndClassEx.hIconSm = reinterpret_cast<HICON>(windowClass.SmallIcon().Use());
        m_Atom = User32::RegisterClassExT(&wndClassEx);
    }        
    
    WindowClassRegistration::~WindowClassRegistration()
    {
        User32::UnregisterClassT(m_windowClass.Name(), reinterpret_cast<HINSTANCE>(m_windowClass.Instance().Use()));
    }

}}}//qor::platform::nswindows
