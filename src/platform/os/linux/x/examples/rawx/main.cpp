// Copyright Querysoft Limited 2008 - 2025
//
// Permission is hereby granted, free of charge, to any person or organization
// obtaining a copy of the software and accompanying documentation covered by
// this license (the "Software") to use, reproduce, display, distribute,
// execute, and transmit the Software, and to prepare derivative works of the
// Software, and to permit third-parties to whom the Software is furnished to
// do so, all subject to the following:
// 
// The copyright notices in the Software and this entire statement, including
// the above license grant, this restriction and the following disclaimer,
// must be included in all copies of the Software, in whole or in part, and
// all derivative works of the Software, unless such copies or derivative
// works are solely in the form of machine-executable object code generated by
// a source language processor.
// 
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT
// SHALL THE COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE
// FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN CONTRACT, TORT OR OTHERWISE,
// ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
// DEALINGS IN THE SOFTWARE.

#include "sdk/using_framework.h"
#include "src/platform/os/linux/x/xlib/xlib.h"
#include "src/platform/os/linux/x/xlib/display.h"
#include "src/platform/os/linux/x/xlib/screen.h"
#include "src/platform/os/linux/x/xlib/window.h"

const char* appName = "XRaw";

qor_pp_implement_module(appName)
qor_pp_module_requires(ICurrentThread)
qor_pp_module_requires(XClient)

int main()
{
    auto xrawApp = AppBuilder().Build(appName);

    xrawApp->SetRole<Role>(
        [](ref_of<IRole>::type role)
        {
            qor_pp_fcontext;
            
            role->AddFeature<ThreadPool>(
                [](ref_of<ThreadPool>::type threadPool)
                {
                    threadPool->SetThreadCount(2);
                    qor::framework::CurrentThread::GetCurrent().SetName("Main");
                }
            );

            role->AddFeature<qor::platform::nslinux::XClient>();
        }
    );

    return xrawApp(qor_shared).Run
    (
        make_runable(

            []()->int
            {
                auto xclient = AppBuilder().TheApplication(qor_shared)->GetRole(qor_shared)->GetFeature<qor::platform::nslinux::XClient>();
                {
                    auto defaultDisplay = xclient->GetDisplay(0);

                    int status = defaultDisplay->NoOp();                
                    int connctionNumber = defaultDisplay->ConnectionNumber();
                    int protocolVersion = defaultDisplay->ProtocolVersion();
                    int protocolRevision = defaultDisplay->ProtocolRevision();

                    std::string displayString = defaultDisplay->DisplayString();
                    std::string serverVendor = defaultDisplay->ServerVendor();
                    int vendorRelease = defaultDisplay->VendorRelease();
                    int numberOfScreens = defaultDisplay->ScreenCount();
                    int defaultScreen = defaultDisplay->DefaultScreen();

                    int depth = defaultDisplay->DefaultDepth();
                    int bitmapBitOrder = defaultDisplay->BitmapBitOrder();
                    int bitmapUnit = defaultDisplay->BitmapUnit();
                    int bitmapPad = defaultDisplay->BitmapPad();

                    unsigned long blackPixel = defaultDisplay->BlackPixel();
                    unsigned long whitePixel = defaultDisplay->WhitePixel();
                    unsigned long defaultColourmap = defaultDisplay->DefaultColourmap();
                    //defaultDisplay->DefaultGC();
                    int cells = defaultDisplay->DisplayCells();
                    int planes = defaultDisplay->DisplayPlanes();
                    int width = defaultDisplay->Width();
                    int height = defaultDisplay->Height();
                    int widthMM = defaultDisplay->WidthMM();
                    int heightMM = defaultDisplay->HeightMM();
                    std::vector<int> depths = defaultDisplay->ListDepths();

                    long maxRequestSize = defaultDisplay->MaxRequestSize();
                    auto formats = defaultDisplay->ListPixmapFormats();

                    qor::platform::nslinux::x::VisualInfoQuery visualInfoQuery;
                    visualInfoQuery.SetDepth(24);
                    visualInfoQuery.SetBitsPerRGB(8);                    

                    auto visualInfo = defaultDisplay->GetVisualInfo(visualInfoQuery);

                    auto window = defaultDisplay->DefaultRootWindow();

                    auto screen = defaultDisplay->ScreenOfDisplay(defaultDisplay->DefaultScreen());

                    unsigned long screenBlackPixel = screen.BlackPixel();
                    auto screenRootWindow = screen.RootWindow();

                    auto toplevelWindow = screenRootWindow.CreateChildWindow(0, 0, 800, 600, 1, 0, 0x00aabbcc);                    
                    toplevelWindow->SetBorderWidth(12);

                    qor::platform::nslinux::x::WindowChangeQuery windowChangeQuery;
                    windowChangeQuery.SetBorderWidth(24);
                    windowChangeQuery.Setx(20);
                    windowChangeQuery.Sety(20);
                    toplevelWindow->Configure(windowChangeQuery);

                    qor::platform::nslinux::x::SetWindowAttributesQuery windowSetAttribs;
                    windowSetAttribs.SetSaveUnder(1);
                    windowSetAttribs.SetBitGravity(qor::platform::nslinux::x::Window::NorthWestGravity);
                    toplevelWindow->ChangeAttributes(windowSetAttribs);

                    auto hints = toplevelWindow->GetWMHints();
                    hints.flags = (1L << 1);
                    hints.initial_state = 3;
                    toplevelWindow->SetWMHints(hints);

                    std::string motifHintsAtomName("_MOTIF_WM_HINTS");
                    unsigned long motifWMHintsProperty = defaultDisplay->GetAtom(motifHintsAtomName.data());

                    qor::platform::nslinux::x::MotifWmHints mhints = {0};
                    mhints.flags = MWM_HINTS_DECORATIONS;
                    mhints.decorations = 0;

                    toplevelWindow->ChangeProperty(motifWMHintsProperty, motifWMHintsProperty, 32, qor::platform::nslinux::x::Window::PropModeReplace, (unsigned char*)(&mhints), sizeof(mhints)/sizeof(long));

                    std::vector<unsigned long> atoms = toplevelWindow->ListProperties();

                    for(unsigned long prop : atoms)
                    {
                        std::string name(defaultDisplay->GetAtomName(prop));

                        unsigned char* data;
                        unsigned long actualType = 0;
                        int actualFormat = 0;
                        unsigned long itemsReturned = 0;
                        unsigned long bytesUnread = 0;

                        toplevelWindow->GetProperty(prop, 0, 1, 0, qor::platform::nslinux::x::Window::AnyPropertyType, &actualType, &actualFormat, &itemsReturned, &bytesUnread, &data);

                        if(bytesUnread != 0)
                        {
                            //consider getting some more
                        }
                        if(data != nullptr)
                        {
                            //data will need to be freed
                        }
                    }
                                        
                    toplevelWindow->Map();
                    defaultDisplay->Flush();

                    sleep(5);
                    toplevelWindow->Unmap();
                }                

                return EXIT_SUCCESS;
            }
        )
    );
}

