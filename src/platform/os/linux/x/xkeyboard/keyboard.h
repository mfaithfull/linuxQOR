// Copyright Querysoft Limited 2008 - 2025
//
// Permission is hereby granted, free of charge, to any person or organization
// obtaining a copy of the software and accompanying documentation covered by
// this license (the "Software") to use, reproduce, display, distribute,
// execute, and transmit the Software, and to prepare derivative works of the
// Software, and to permit third-parties to whom the Software is furnished to
// do so, all subject to the following:
// 
// The copyright notices in the Software and this entire statement, including
// the above license grant, this restriction and the following disclaimer,
// must be included in all copies of the Software, in whole or in part, and
// all derivative works of the Software, unless such copies or derivative
// works are solely in the form of machine-executable object code generated by
// a source language processor.
// 
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT
// SHALL THE COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE
// FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN CONTRACT, TORT OR OTHERWISE,
// ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
// DEALINGS IN THE SOFTWARE.

#ifndef QOR_PP_H_LINUX_XKEYBOARD
#define QOR_PP_H_LINUX_XKEYBOARD

#include <string>
#include <vector>

#include "src/platform/os/linux/x/xlib/display.h"
#include "src/platform/os/linux/x/xlib/gc.h"
#include "src/platform/os/linux/x/xlib/image.h"
#include "src/platform/os/linux/x/xlib/visual.h"
#include "src/platform/os/linux/x/xinput/device.h"

//All types on this interface must be portable
namespace qor{ namespace platform { namespace nslinux{ namespace x{
    
    class qor_pp_module_interface(QOR_LINX) Display;
    class qor_pp_module_interface(QOR_LINX) Window;
    class qor_pp_module_interface(QOR_LINX) Cursor;
    struct ExtCodes;
    
    struct kbDesc 
    {
        void*	            dpy;
        unsigned short	 	flags;
        unsigned short		device_spec;
        unsigned char		min_key_code;
        unsigned char		max_key_code;

        void*		        ctrls;
        void*		        server;
        void*		        map;
        void*		        indicators;
        void*		        names;
        void*		        compat;
        void*		        geom;
    };

    struct kbMapChanges 
    {
        unsigned short		changed;
        unsigned char		min_key_code;
        unsigned char		max_key_code;
        unsigned char		first_type;
        unsigned char		num_types;
        unsigned char		first_key_sym;
        unsigned char		num_key_syms;
        unsigned char		first_key_act;
        unsigned char		num_key_acts;
        unsigned char		first_key_behavior;
        unsigned char		num_key_behaviors;
        unsigned char 		first_key_explicit;
        unsigned char		num_key_explicit;
        unsigned char		first_modmap_key;
        unsigned char		num_modmap_keys;
        unsigned char		first_vmodmap_key;
        unsigned char		num_vmodmap_keys;
        unsigned char		pad;
        unsigned short		vmods;
    };    

    struct kbNameChanges 
    {
        unsigned int 		changed;
        unsigned char		first_type;
        unsigned char		num_types;
        unsigned char		first_lvl;
        unsigned char		num_lvls;
        unsigned char		num_aliases;
        unsigned char		num_rg;
        unsigned char		first_key;
        unsigned char		num_keys;
        unsigned short		changed_vmods;
        unsigned long		changed_indicators;
        unsigned char		changed_groups;
    };

    struct kbMapNotifyEvent
    {
        int 		type;		/* XkbAnyEvent */
        unsigned long 	serial;		/* of last req processed by server */
        int 		send_event;	/* is this from a SendEvent request */
        void*	    display;	/* Display the event was read from */
        unsigned long	time;		/* milliseconds */
        int 		xkb_type;	/* XkbMapNotify */
        int 		device;		/* device ID */
        unsigned int 	changed;	/* fields which have been changed */
        unsigned int 	flags;		/* reserved */
        int 		first_type;	/* first changed key type */
        int 		num_types;	/* number of changed key types */
        unsigned char		min_key_code;
        unsigned char		max_key_code;
        unsigned char		first_key_sym;
        unsigned char		first_key_act;
        unsigned char		first_key_behavior;
        unsigned char		first_key_explicit;
        unsigned char		first_modmap_key;
        unsigned char		first_vmodmap_key;
        int		num_key_syms;
        int		num_key_acts;
        int		num_key_behaviors;
        int		num_key_explicit;
        int 		num_modmap_keys;
        int 		num_vmodmap_keys;
        unsigned int 	vmods;		/* mask of changed virtual mods */
    };

    struct kbNamesNotifyEvent 
    {
        int 		    type;		/* XkbAnyEvent */
        unsigned long 	serial;		/* of last req processed by server */
        int 		    send_event;	/* is this from a SendEvent request? */
        void*	        display;	/* Display the event was read from */
        unsigned long   time;		/* milliseconds */
        int 		    xkb_type;	/* XkbNamesNotify */
        int	 	        device;		/* device ID */
        unsigned int 	changed;	/* names that have changed */
        int	 	        first_type;	/* first key type with new name */
        int	 	        num_types;	/* number of key types with new names */
        int	 	        first_lvl;	/* first key type new new level names */
        int	 	        num_lvls;	/* # of key types w/new level names */
        int	 	        num_aliases;	/* total number of key aliases*/
        int	 	        num_radio_groups;/* total number of radio groups */
        unsigned int 	changed_vmods;	/* virtual modifiers with new names */
        unsigned int 	changed_groups;	/* groups with new names */
        unsigned int 	changed_indicators;/* indicators with new names */
        int		        first_key;	/* first key with new name */
        int		        num_keys;	/* number of keys with new names */
    };

    struct kbComponentNames 
    {
        char *			 keymap;
        char *			 keycodes;
        char *			 types;
        char *			 compat;
        char *			 symbols;
        char *			 geometry;
    };

    struct kbControlsNotifyEvent
    {
        int 		    type;		/* XkbAnyEvent */
        unsigned long 	serial;		/* of last req processed by server */
        int 		    send_event;	/* is this from a SendEvent request? */
        void*	        display;	/* Display the event was read from */
        unsigned long 	time;		/* milliseconds */
        int 		    xkb_type;	/* XkbControlsNotify */
        int 		    device;		/* device ID */
        unsigned int	changed_ctrls;	/* controls with changed sub-values */
        unsigned int 	enabled_ctrls;	/* controls currently enabled */
        unsigned int	enabled_ctrl_changes;/* controls just {en,dis}abled */
        int 		    num_groups;	/* total groups on keyboard */
        unsigned char	keycode;	/* key that caused change or 0 */
        char 		    event_type;	/* type of event that caused change */
        char 		    req_major;	/* if keycode==0, major and minor */
        char 		    req_minor;	/* opcode of req that caused change */
    };

    class qor_pp_module_interface(QOR_LINXKEYBOARD) XKeyboard
    {
    public:
    
        XKeyboard(Display* dpy);
        virtual ~XKeyboard();

        int	IgnoreExtension(int ignore);        
        int	LibraryVersion(int* libMajorRtrn, int* libMinorRtrn);
        Display OpenDisplay(char* name, int* evReturn, int* errReturn, int* majorReturn, int* minorReturn, int* reason);
        int	QueryExtension(Display* dpy, int* opcodeReturn, int* eventBaseReturn, int* errorBaseReturn, int* majorRtrn, int* minorRtrn);
        int	UseExtension(Display* dpy, int* majorReturn, int* minorReturn);
        unsigned int SetXlibControls(Display* dpy, unsigned int affect, unsigned int values);
        unsigned int GetXlibControls(Display* dpy);
        unsigned int XlibControlsImplemented(void);
        typedef	unsigned long(*InternAtomFunc)(Display* dpy, const char* name, int only_if_exists);
        typedef char*(*GetAtomNameFunc)(Display* dpy, unsigned long atom);
        void SetAtomFuncs( InternAtomFunc getAtom, GetAtomNameFunc getName );
        unsigned char KeycodeToKeysym(Display* dpy, unsigned int kc, int group, int level);
        unsigned int KeysymToModifiers(Display* dpy, unsigned char ks);
        int LookupKeySym(Display* dpy, unsigned char keycode, unsigned int modifiers, unsigned int* modifiers_return, unsigned long* keysym_return);
        int LookupKeyBinding(Display* dpy, unsigned long sym_rtrn, unsigned int mods, char* buffer, int nbytes, int* extra_rtrn);
        int TranslateKeyCode(void* xkb, unsigned char keycode, unsigned int modifiers, unsigned int* modifiers_return, unsigned long* keysym_return);
        int TranslateKeySym(Display* dpy, unsigned long* sym_return, unsigned int modifiers, char* buffer, int nbytes, int* extra_rtrn);
        int	SetAutoRepeatRate(Display* dpy, unsigned int deviceSpec, unsigned int delay, unsigned int interval);
        int GetAutoRepeatRate(Display* dpy, unsigned int deviceSpec, unsigned int* delayRtrn, unsigned int* intervalRtrn);
        int ChangeEnabledControls(Display* dpy, unsigned int deviceSpec, unsigned int affect, unsigned int values);
        int DeviceBell(Display* dpy, Window win, int deviceSpec, int bellClass, int bellID, int percent, unsigned long name);
        int ForceDeviceBell(Display* dpy, int deviceSpec, int bellClass, int bellID, int percent);
        int DeviceBellEvent(Display* dpy, Window win, int deviceSpec, int bellClass, int bellID, int percent, unsigned long name);
        int Bell(Display* dpy, Window win, int percent, unsigned long name);
        int ForceBell(Display* dpy, int percent);
        int BellEvent(Display* dpy, Window win, int percent, unsigned long name);
        int SelectEvents(Display* dpy, unsigned int deviceID, unsigned int affect, unsigned int values);
        int SelectEventDetails(Display* dpy, unsigned int deviceID, unsigned int eventType, unsigned long affect, unsigned long details);
        void NoteMapChanges(kbMapChanges* old, kbMapNotifyEvent* new_, unsigned int wanted);
        void NoteNameChanges(kbNameChanges* old, kbNamesNotifyEvent* new_, unsigned int wanted);
        int GetIndicatorState(Display* dpy, unsigned int deviceSpec, unsigned int* pStateRtrn);
        int GetDeviceIndicatorState(Display* dpy, unsigned int deviceSpec, unsigned int ledClass, unsigned int ledID, unsigned int* pStateRtrn);
        int GetIndicatorMap(Display* dpy, unsigned long which, void* desc);
        int SetIndicatorMap(Display* dpy, unsigned long which, void* desc);

        //#define	XkbNoteIndicatorMapChanges(o,n,w) ((o)->map_changes|=((n)->map_changes&(w)))
        //#define	XkbNoteIndicatorStateChanges(o,n,w) ((o)->state_changes|=((n)->state_changes&(w)))
        //#define	XkbGetIndicatorMapChanges(d,x,c) XkbGetIndicatorMap((d),(c)->map_changes,x))
        //#define	XkbChangeIndicatorMaps(d,x,c) (XkbSetIndicatorMap((d),(c)->map_changes,x))

        int GetNamedIndicator(Display* dpy, unsigned long name, int* pNdxRtrn, int* pStateRtrn, void* pMapRtrn, int* pRealRtrn);
        int GetNamedDeviceIndicator(Display* dpy, unsigned int deviceSpec, unsigned int ledClass, unsigned int ledID, unsigned long name, int* pNdxRtrn, int* pStateRtrn, void* pMapRtrn, int* pRealRtrn);
        int SetNamedIndicator(Display* dpy, unsigned long name, int changeState, int state, int createNewMap, void* pMap);
        int SetNamedDeviceIndicator(Display* dpy, unsigned int deviceSpec, unsigned int ledClass, unsigned int ledID, unsigned long name, int changeState, int state, int createNewMap, void* pMap);
        int LockModifiers(Display* dpy, unsigned int deviceSpec, unsigned int affect, unsigned int values);
        int LatchModifiers(Display* dpy, unsigned int deviceSpec, unsigned int affect, unsigned int values);
        int LockGroup(Display* dpy, unsigned int deviceSpec, unsigned int group);
        int LatchGroup(Display* dpy, unsigned int deviceSpec, unsigned int group);
        int SetServerInternalMods(Display* dpy, unsigned int deviceSpec, unsigned int affectReal, unsigned int realValues, unsigned int affectVirtual, unsigned int virtualValues);
        int SetIgnoreLockMods(Display* dpy, unsigned int deviceSpec, unsigned int affectReal, unsigned int realValues, unsigned int affectVirtual, unsigned int virtualValues);
        int VirtualModsToReal(void* xkb, unsigned int virtual_mask, unsigned int* mask_rtrn);
        int ComputeEffectiveMap(void* xkb, void* type, unsigned char* map_rtrn);
        int InitCanonicalKeyTypes(void* xkb, unsigned int which, int keypadVMod);
        void* AllocKeyboard();
        void FreeKeyboard(void* xkb, unsigned int which, int freeDesc);
        int AllocClientMap(void* xkb, unsigned int which, unsigned int nTypes);
        int AllocServerMap(void* xkb, unsigned int which, unsigned int nActions);
        void FreeClientMap(void* xkb, unsigned int what, int freeMap);
        void FreeServerMap(void* xkb, unsigned int what, int freeMap);
        void* AddKeyType(void* xkb, unsigned long name, int map_count, int want_preserve, int num_lvls);
        int AllocIndicatorMaps(void* xkb);
        void FreeIndicatorMaps(void* xkb);
        void* GetMap(Display* dpy, unsigned int which, unsigned int deviceSpec);
        int GetUpdatedMap(Display* dpy, unsigned int which, void* desc);
        int GetMapChanges(Display* dpy, void* xkb, kbMapChanges* changes);
        int RefreshKeyboardMapping(kbMapNotifyEvent* event);
        int GetKeyTypes(Display* dpy, unsigned int first, unsigned int num, void* xkb);
        int GetKeySyms(Display* dpy, unsigned int first, unsigned int num, void* xkb);
        int GetKeyActions(Display* dpy, unsigned int first, unsigned int num, void* xkb);
        int GetKeyBehaviors(Display* dpy, unsigned int firstKey, unsigned int nKeys, void* desc);
        int GetVirtualMods(Display* dpy, unsigned int which, void* desc);
        int GetKeyExplicitComponents(Display* dpy, unsigned int firstKey, unsigned int nKeys, void* desc);
        int GetKeyModifierMap(Display* dpy, unsigned int firstKey, unsigned int nKeys, void* desc);
        int GetKeyVirtualModMap(Display* dpy, unsigned int first, unsigned int num, void* xkb);
        int AllocControls(void* xkb, unsigned int which);
        void FreeControls(void* xkb, unsigned int which, int freeMap);
        int GetControls(Display* dpy, unsigned long which, void* desc);
        int SetControls(Display* dpy, unsigned long which, void* desc);
        void NoteControlsChanges(void* old, kbControlsNotifyEvent* new_, unsigned int wanted);

        //#define	XkbGetControlsChanges(d,x,c)	XkbGetControls(d,(c)->changed_ctrls,x)
        //#define	XkbChangeControls(d,x,c)	XkbSetControls(d,(c)->changed_ctrls,x)

        int AllocCompatMap(void* xkb, unsigned int which, unsigned int nInterpret);
        void FreeCompatMap(void* xkb, unsigned int which, int freeMap);
        int GetCompatMap(Display* dpy, unsigned int which, void* xkb);
        int SetCompatMap(Display* dpy, unsigned int which, void* xkb, int updateActions);
        void* AddSymInterpret(void* xkb, void* si, int updateMap, void* changes);
        int AllocNames(void* xkb, unsigned int which, int nTotalRG, int nTotalAliases);
        int GetNames(Display* dpy, unsigned int which, void* desc);
        int SetNames(Display* dpy, unsigned int which, unsigned int firstType, unsigned int nTypes, void* desc);
        int ChangeNames(Display* dpy, void* xkb, kbNameChanges* changes);
        void FreeNames(void* xkb, unsigned int which, int freeMap);
        int GetState(Display* dpy, unsigned int deviceSpec, void* rtrnState);
        int SetMap(Display* dpy, unsigned int which, void* desc);
        int ChangeMap(Display* dpy, void* desc, kbMapChanges* changes);
        int SetDetectableAutoRepeat(Display* dpy, int detectable, int* supported);
        int GetDetectableAutoRepeat(Display* dpy, int* supported);
        int SetAutoResetControls(Display* dpy, unsigned int changes, unsigned int* auto_ctrls, unsigned int* auto_values);
        int GetAutoResetControls(Display* dpy, unsigned int* auto_ctrls, unsigned int* auto_ctrl_values);
        int SetPerClientControls(Display* dpy, unsigned int change, unsigned int* values);
        int GetPerClientControls(Display* dpy, unsigned int* ctrls);
        int CopyKeyType(void* from, void* into);
        int CopyKeyTypes(void* from, void* into, int numTypes);
        int ResizeKeyType(void* xkb, int type_ndx, int map_count, int want_preserve, int new_num_lvls);
        unsigned long* ResizeKeySyms(void* desc, int forKey, int symsNeeded);
        void* ResizeKeyActions(void* desc, int forKey, int actsNeeded);
        int ChangeTypesOfKey(void* xkb, int key, int num_groups, unsigned int groups, int* newTypes, kbMapChanges* pChanges);
        int ChangeKeycodeRange(void* xkb, int minKC, int maxKC, void* changes);
        void*	ListComponents(Display* dpy, unsigned int deviceSpec, kbComponentNames* ptrns, int* max_inout);
        void FreeComponentList(void* list);
        void* GetKeyboard(Display* dpy, unsigned int which, unsigned int deviceSpec);
        void* GetKeyboardByName(Display* dpy, unsigned int deviceSpec, kbComponentNames* names, unsigned int want, unsigned int need, int load);
        int KeyTypesForCoreSymbols(void* xkb, int map_width, unsigned long* core_syms, unsigned int prot, int* types_inout, unsigned long* xkb_syms_rtrn);
        int ApplyCompatMapToKey(void* xkb, unsigned char key, void* changes);
        int UpdateMapFromCore(void* xkb, unsigned char first_key, int num_keys, int map_width, unsigned long* core_keysyms, void* changes);
        void* AddDeviceLedInfo(void* devi, unsigned int ledClass, unsigned int ledId);
        int ResizeDeviceButtonActions(void* devi, unsigned int newTotal);
        void* AllocDeviceInfo(unsigned int deviceSpec, unsigned int nButtons, unsigned int szLeds);
        void FreeDeviceInfo(void* devi, unsigned int which, int freeDevI);
        void NoteDeviceChanges(void* old, void* new_, unsigned int wanted);
        void* GetDeviceInfo(Display* dpy, unsigned int which, unsigned int deviceSpec, unsigned int ledClass, unsigned int ledID);
        int GetDeviceInfoChanges(Display* dpy, void* devi, void* changes);
        int GetDeviceButtonActions(Display* dpy, void* devi, int all, unsigned int first, unsigned int nBtns);
        int GetDeviceLedInfo(Display* dpy, 
            void* devi, 
            unsigned int ledClass, //(class, XIDflt, XIAll)
            unsigned int ledId, //(id, XIDflt, XIAll)
            unsigned int which // (XkbXI_Indicator{Names,Map}Mask
        );
        int SetDeviceInfo(Display* dpy, unsigned int which, void* devi);
        int ChangeDeviceInfo(Display* dpy, void* desc, void* changes);
        int SetDeviceLedInfo(Display* dpy, void* devi, unsigned int ledClass, unsigned int ledID, unsigned int which);
        int SetDeviceButtonActions(Display* dpy, void* devi, unsigned int first, unsigned int nBtns);
        char ToControl(char c);
        int SetDebuggingFlags(Display* dpy, unsigned int mask, unsigned int flags, char* msg, unsigned int ctrls_mask, unsigned int	ctrls, unsigned int* rtrn_flags, unsigned int* rtrn_ctrls);
        int ApplyVirtualModChanges(void* xkb, unsigned int changed, void* changes);
        int UpdateActionVirtualMods(void* xkb, void* act, unsigned int changed);
        void UpdateKeyTypeVirtualMods(void* xkb, void* type, unsigned int changed, void* changes);

    protected:
        Display* m_display;
        ExtCodes m_extCodes;
    };

}}}}//qor::platform::nslinux::x

#endif//QOR_PP_H_LINUX_XKEYBOARD

