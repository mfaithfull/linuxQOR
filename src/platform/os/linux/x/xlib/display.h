// Copyright Querysoft Limited 2008 - 2025
//
// Permission is hereby granted, free of charge, to any person or organization
// obtaining a copy of the software and accompanying documentation covered by
// this license (the "Software") to use, reproduce, display, distribute,
// execute, and transmit the Software, and to prepare derivative works of the
// Software, and to permit third-parties to whom the Software is furnished to
// do so, all subject to the following:
// 
// The copyright notices in the Software and this entire statement, including
// the above license grant, this restriction and the following disclaimer,
// must be included in all copies of the Software, in whole or in part, and
// all derivative works of the Software, unless such copies or derivative
// works are solely in the form of machine-executable object code generated by
// a source language processor.
// 
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT
// SHALL THE COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE
// FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN CONTRACT, TORT OR OTHERWISE,
// ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
// DEALINGS IN THE SOFTWARE.

#ifndef QOR_PP_H_LINUX_X_DISPLAY
#define QOR_PP_H_LINUX_X_DISPLAY

#include <string>
#include <format>
#include <vector>
#include <functional>

#include "visualinfoquery.h"
#include "event.h"
#include "keysymbols.h"

namespace qor{ namespace platform { namespace nslinux{ namespace x{

    class qor_pp_module_interface(QOR_LINX) GC;
    class qor_pp_module_interface(QOR_LINX) Window;
    class qor_pp_module_interface(QOR_LINX) Screen;
    class qor_pp_module_interface(QOR_LINX) Visual;
    class qor_pp_module_interface(QOR_LINX) Pixmap;

    struct PixmapFormatValue
    {
        int depth;
        int bits_per_pixel;
        int scanline_pad;
    };

    struct ModifierKeymap
    {
        int max_keypermod;	    // The server's max # of keys per modifier
        unsigned char* modifiermap;	// An 8 by max_keypermod array of modifiers
    };

    class qor_pp_module_interface(QOR_LINX) Display
    {
    public:

        Display(const std::string& protocol, const std::string& hostname, int display_number = 0, int screen_number = 0);
        Display(const char* name = nullptr);
        Display(void* display);
        ~Display();

        bool IsTemporary()
        {
            return temporary;
        }

        void* Use();
        int DefaultScreen();
        unsigned long BlackPixel();
        unsigned long BlackPixel(int screen_number);
        unsigned long WhitePixel();
        unsigned long WhitePixel(int screen_number);
        int ConnectionNumber();
        int DefaultDepth();
        int DefaultDepth(int screen_number);
        unsigned long DefaultColourmap();
        unsigned long DefaultColourmap(int screen_number);
        const std::vector<int> ListDepths();
        const std::vector<int> ListDepths(int screen_number);
        GC DefaultGC();
        GC DefaultGC(int screen_number);
        Window DefaultRootWindow();  
        Screen DefaultScreenOfDisplay();
        Screen ScreenOfDisplay(int screen_number);
        Visual DefaultVisual();
        Visual DefaultVisual(int screen_number);
        int DisplayCells();//entries in colour map
        int DisplayCells(int screen_number);//entries in colour map
        int DisplayPlanes();
        int DisplayPlanes(int screen_number);
        const std::string DisplayString();
        long MaxRequestSize();
        unsigned long LastKnownRequestProcessed();
        unsigned long NextRequest();
        int ProtocolVersion();
        int ProtocolRevision();
        int QLength();
        Window RootWindow();
        Window RootWindow(int screen_number);
        int ScreenCount();
        const std::string ServerVendor();
        const int VendorRelease();
        int ImageByteOrder();// LSBFirst or MSBFirst
        int BitmapUnit();//scan line length in bits
        int BitmapBitOrder();//LSBFirst or MSBFirst
        int BitmapPad();//scan line modulus/padding in bits
        int Height();//pixels
        int HeightMM();
        int Width();//pixels
        int WidthMM();
        int Height(int screen_number);//pixels
        int HeightMM(int screen_number);
        int Width(int screen_number);//pixels
        int WidthMM(int screen_number);
        int NoOp();
        int SetCloseDownMode(int close_mode);//DestroyAll, RetainPermanent, or RetainTemporary.
        const std::vector<PixmapFormatValue> ListPixmapFormats();
        void Lock();
        void Unlock();
        Pixmap GetPixmap(unsigned long drawableId, unsigned int width, unsigned int height, unsigned int depth);
        std::vector<VisualInfo> GetVisualInfo(long vinfo_mask, VisualInfo& vinfo_template);
        std::vector<VisualInfo> GetVisualInfo(VisualInfoQuery& visualInfoQuery);
        int Flush();
        unsigned long GetAtom(const char* name);
        unsigned long CreateAtom(char* name);
        const std::string GetAtomName(unsigned long atom);
        int NextEvent(Event& event);
        int Pending();
        int ProcessEvent(std::function< eventHandler(int)> filterType, int& result);
        int LookupKeySymbol(KeyEvent& keyEvent, int index);
        int WarpPointer(unsigned long src_w, unsigned long dest_w, int src_x, int src_y, unsigned int src_width, unsigned int src_height, int dest_x, int dest_y);
        int InstallColourmap(unsigned long colourmap);
        int UninstallColourmap(unsigned long colourmap);
        int TranslateCoordinates(unsigned long src_w, unsigned long dest_w, int src_x, int src_y, int& dest_x_return, int& dest_y_return, unsigned long& child_return);
        int Sync(bool discard);
        int StoreBytes(const char* bytes, int nbytes);
        int StoreBuffer(const char* bytes, int nbytes, int buffer);
        int GetPointerMapping(std::vector<unsigned char>& buttons);
        int SetPointerMapping(const std::vector<unsigned char>& buttons);
        int SetModifierMapping(ModifierKeymap& modmap);
        int SetInputFocus(unsigned long focus, int revert_to, unsigned long time);

    private:

        bool temporary;
        void* m_display;
    };

}}}}//qor::platform::nslinux::x
    
#endif//QOR_PP_H_LINUX_X_DISPLAY