// Copyright Querysoft Limited 2008 - 2025
//
// Permission is hereby granted, free of charge, to any person or organization
// obtaining a copy of the software and accompanying documentation covered by
// this license (the "Software") to use, reproduce, display, distribute,
// execute, and transmit the Software, and to prepare derivative works of the
// Software, and to permit third-parties to whom the Software is furnished to
// do so, all subject to the following:
// 
// The copyright notices in the Software and this entire statement, including
// the above license grant, this restriction and the following disclaimer,
// must be included in all copies of the Software, in whole or in part, and
// all derivative works of the Software, unless such copies or derivative
// works are solely in the form of machine-executable object code generated by
// a source language processor.
// 
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT
// SHALL THE COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE
// FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN CONTRACT, TORT OR OTHERWISE,
// ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
// DEALINGS IN THE SOFTWARE.

#include "src/configuration/configuration.h"

#include <sys/mman.h>                       //Unixish specific header
#include <sys/syscall.h>                    //Unixish specific header 
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "sdk/using_framework.h"
#include "sdk/platform/os/linux/wayland.h"  //Linux specific. NOTE: This sample is Linux only

#include "bindmem.h"                        //Headers specific to this sample
#include "sharedmem.h"
#include "custompopup.h"
#include "customwindow.h"
#include "custompointercontroller.h"
#include "customkeyboardcontroller.h"

int waylandExampleRun(ref_of<wl::XDGSession>::type session)
{
    auto window = new_ref<ExampleWindow>(session);              //Create a custom Top Level window
    window->SetTitle("Wayland XDG Example");                    //Set window properties
    customKeyboardController keycon(session);                   //Setup a Keyboard controller to catch Esc and quit the Session
    customPointerController pointercon(session, window);        //Setup a Pointer controller to catch clicks    
    return session->Run();                                      //Loop until the Session is ended. Press Esc to quit.
}

int waylandExampleCommon()
{
    auto waylandClient = GetFeature<WaylandClient>();           //Get a reference to the Wayland Client feature
    auto display = waylandClient(qor_shared).GetDisplay();      //Get the default local display
    auto session = new_ref<wl::XDGSession>(display);            //Create a session with the Window Manager and IO devices
    return waylandExampleRun(session);
}

const char* appName = "registry";
qor_pp_implement_module(appName)                            //Make this executable a QOR Module.
qor_pp_module_requires(WaylandClient)                       //Persuade the linker to link the WaylandClient implementation

int main(int argc, char **argv) 
{    
    auto registryApp = AppBuilder().Build(appName);         //Create the QOR Application container singleton

    registryApp->SetRole<Role>(                             //Set the Role to an instance of the base Role type
        [](ref_of<IRole>::type role)                        //We're given the IRole instance to configure
        {
            role->AddFeature<WaylandClient>();              //Add the WaylandClient Feature
        }
    ).Run(                                                  //Run the returned Application to manage the added features
        make_runable(                                       //This turns a function int(...) into a Runable object
            []()->int
            {
                int result = waylandExampleCommon();        //The guts of our application
                printf("Disconnected from display\n");      //Output to confirm we cleaned up neatly and reached this point
                return result;
            }
        )
    );
}