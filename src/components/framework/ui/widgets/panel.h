// Copyright Querysoft Limited 2008 - 2025
//
// Permission is hereby granted, free of charge, to any person or organization
// obtaining a copy of the software and accompanying documentation covered by
// this license (the "Software") to use, reproduce, display, distribute,
// execute, and transmit the Software, and to prepare derivative works of the
// Software, and to permit third-parties to whom the Software is furnished to
// do so, all subject to the following:
// 
// The copyright notices in the Software and this entire statement, including
// the above license grant, this restriction and the following disclaimer,
// must be included in all copies of the Software, in whole or in part, and
// all derivative works of the Software, unless such copies or derivative
// works are solely in the form of machine-executable object code generated by
// a source language processor.
// 
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT
// SHALL THE COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE
// FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN CONTRACT, TORT OR OTHERWISE,
// ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
// DEALINGS IN THE SOFTWARE.

#ifndef QOR_PP_H_COMPONENTS_FRAMEWORK_UI_WIDGETS_PANEL
#define QOR_PP_H_COMPONENTS_FRAMEWORK_UI_WIDGETS_PANEL

#include <string>

#include "widgetbase.h"
#include "event.h"
#include "src/components/framework/ui/layout/reflect.h"
#include "src/components/framework/ui/layout/size.h"
#include "src/components/framework/ui/layout/elements.h"

namespace qor{ namespace components{ namespace ui {

    //State passed to the `Panel` component's render function.    
    struct qor_pp_module_interface(QOR_WIDGETS) PanelRenderState 
    {
        Element inner;             //< The element wrapped inside this window.
        const std::string& title;  //< The title of the window.
        bool active = false;       //< Whether the window is the active one.
    };

    //Options for the `Panel` component.
    struct qor_pp_module_interface(QOR_WIDGETS) PanelOptions 
    {
        Widget inner;            //< The component wrapped by this window.
        std::string title = "";  //< The title displayed by this window.

        int left = 0;     //< The left side position of the window.
        int top = 0;      //< The top side position of the window.
        int width = 320;   //< The width of the window.
        int height = 200;  //< The height of the window.

        std::function<Element(const PanelRenderState&)> render;// An optional function to customize the window appearance:
    };

    Widget panel(PanelOptions content);

    Element DefaultRenderState(const PanelRenderState& state) 
    {
        Element element = state.inner;
        //element = window(element);
        return element;
    }

    Decorator PositionAndSize(int left, int top, int width, int height) 
    {
        return [=](Element element) 
        {
            element |= size(WIDTH, EQUAL, width);
            element |= size(HEIGHT, EQUAL, height);

            auto padding_left = emptyElement() | size(WIDTH, EQUAL, left);
            auto padding_top = emptyElement() | size(HEIGHT, EQUAL, top);

            return vbox(
                {
                    padding_top,
                    hbox({
                        padding_left,
                        element,
                    }),
                }
            );
        };
    }

    class qor_pp_module_interface(QOR_WIDGETS) Panel : public WidgetBase, public PanelOptions 
    {
    public:
        explicit Panel(PanelOptions option) : PanelOptions(std::move(option)) 
        {
            if (!inner) 
            {
                inner = Make<WidgetBase>();
            }
            Add(inner);
        }

    private:

        Element OnRender() final 
        {
            auto element = WidgetBase::Render();

            //const bool captureable = captured_mouse_ || ScreenInteractive::Active()->CaptureMouse();

            const PanelRenderState state = 
            {
                element,
                title,
                Active(),
            };

            element = render ? render(state) : DefaultRenderState(state);

            // Position and record the drawn area of the window.
            //element |= reflect(box_window_);
            element |= PositionAndSize(left, top, width, height);
            //element |= reflect(box_);

            return element;
        }

        bool OnEvent(Event event) final 
        {
            if (WidgetBase::OnEvent(event)) 
            {
                return true;
            }

            TakeFocus();

            return true;
        }

        Box box_;
        Box box_window_;

    };

    Widget panel(PanelOptions content)
    {
        Widget w = Make<Panel>(content);        
        return w;//std::make_shared<Border>(unpack(std::move(content), std::move(title)), border);
    }

}}}//qor::components::ui

#endif//QOR_PP_H_COMPONENTS_FRAMEWORK_UI_WIDGETS_PANEL

