// Copyright Querysoft Limited 2008 - 2025
//
// Permission is hereby granted, free of charge, to any person or organization
// obtaining a copy of the software and accompanying documentation covered by
// this license (the "Software") to use, reproduce, display, distribute,
// execute, and transmit the Software, and to prepare derivative works of the
// Software, and to permit third-parties to whom the Software is furnished to
// do so, all subject to the following:
// 
// The copyright notices in the Software and this entire statement, including
// the above license grant, this restriction and the following disclaimer,
// must be included in all copies of the Software, in whole or in part, and
// all derivative works of the Software, unless such copies or derivative
// works are solely in the form of machine-executable object code generated by
// a source language processor.
// 
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT
// SHALL THE COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE
// FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN CONTRACT, TORT OR OTHERWISE,
// ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
// DEALINGS IN THE SOFTWARE.

#ifndef QOR_PP_H_COMPONENTS_FRAMEWORK_UI_RENDERER_SW_RENDERER
#define QOR_PP_H_COMPONENTS_FRAMEWORK_UI_RENDERER_SW_RENDERER

#include "../render.h"

namespace qor{ namespace components{ namespace ui{ namespace renderer{

    struct SwSurface;
    struct SwTask;
    struct SwCompositor;
    struct SwMpool;

    struct SwRenderer : RenderMethod
    {
        //main features
        bool preUpdate() override;
        RenderData prepare(const RenderShape& rshape, RenderData data, const Matrix& transform, Array<RenderData>& clips, uint8_t opacity, RenderUpdateFlag flags, bool clipper) override;
        RenderData prepare(RenderSurface* surface, RenderData data, const Matrix& transform, Array<RenderData>& clips, uint8_t opacity, RenderUpdateFlag flags) override;
        bool postUpdate() override;
        bool preRender() override;
        bool renderShape(RenderData data) override;
        bool renderImage(RenderData data) override;
        bool postRender() override;
        void dispose(RenderData data) override;
        RenderRegion region(RenderData data) override;
        bool bounds(RenderData data, Point* pt4, const Matrix& m) override;
        bool blend(BlendMethod method) override;
        ColorSpace colorSpace() override;
        const RenderSurface* mainSurface() override;
        bool clear() override;
        bool sync() override;
        bool intersectsShape(RenderData data, const RenderRegion& region) override;
        bool intersectsImage(RenderData data, const RenderRegion& region) override;
        bool target(pixel_t* data, uint32_t stride, uint32_t w, uint32_t h, ColorSpace cs);

        //composition
        SwSurface* request(int channelSize, bool square);
        RenderCompositor* target(const RenderRegion& region, ColorSpace cs, CompositionFlag flags) override;
        bool beginComposite(RenderCompositor* cmp, MaskMethod method, uint8_t opacity) override;
        bool endComposite(RenderCompositor* cmp) override;
        void clearCompositors();

        //post effects
        void prepare(RenderEffect* effect, const Matrix& transform) override;
        bool region(RenderEffect* effect) override;
        bool render(RenderCompositor* cmp, const RenderEffect* effect, bool direct) override;
        void dispose(RenderEffect* effect) override;

        //partial rendering
        void damage(RenderData rd, const RenderRegion& region) override;
        bool partial(bool disable) override;

        SwRenderer(uint32_t threads, EngineOption op);
        static bool term();

    private:
        SwSurface*           surface = nullptr;           //active surface
        Array<SwTask*>       tasks;                       //async task list
        Array<SwSurface*>    compositors;                 //render targets cache list
        RenderDirtyRegion    dirtyRegion;                 //partial rendering support
        SwMpool*             mpool;                       //private memory pool
        bool                 sharedMpool;                 //memory-pool behavior policy
        bool                 fulldraw = true;             //buffer is cleared (need to redraw full screen)

        ~SwRenderer();

        RenderData prepareCommon(SwTask* task, const Matrix& transform, const Array<RenderData>& clips, uint8_t opacity, RenderUpdateFlag flags);
    };

}}}}//qor::components::ui::renderer

#endif//QOR_PP_H_COMPONENTS_FRAMEWORK_UI_RENDERER_SW_RENDERER
