// Copyright Querysoft Limited 2008 - 2025
//
// Permission is hereby granted, free of charge, to any person or organization
// obtaining a copy of the software and accompanying documentation covered by
// this license (the "Software") to use, reproduce, display, distribute,
// execute, and transmit the Software, and to prepare derivative works of the
// Software, and to permit third-parties to whom the Software is furnished to
// do so, all subject to the following:
// 
// The copyright notices in the Software and this entire statement, including
// the above license grant, this restriction and the following disclaimer,
// must be included in all copies of the Software, in whole or in part, and
// all derivative works of the Software, unless such copies or derivative
// works are solely in the form of machine-executable object code generated by
// a source language processor.
// 
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT
// SHALL THE COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE
// FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN CONTRACT, TORT OR OTHERWISE,
// ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
// DEALINGS IN THE SOFTWARE.

#include "src/configuration/configuration.h"

#if( qor_pp_os_target == qor_pp_os_linux )
#   include <sys/ioctl.h>  // for winsize, ioctl, TIOCGWINSZ
#   include <unistd.h>     // for STDOUT_FILENO
#endif

#include "terminal.h"

namespace qor{ namespace components{ namespace tui {

    namespace 
    {
        bool g_cached = false;
        Terminal::Colour g_cached_supported_colour;

        Dimensions& FallbackSize() 
        {
#if defined(__EMSCRIPTEN__)
            // This dimension was chosen arbitrarily to be able to display:
            // https://arthursonzogni.com/FTXUI/examples
            // This will have to be improved when someone has time to implement and need
            // it.
            constexpr int fallback_width = 140;
            constexpr int fallback_height = 43;
#else
            // The terminal size in VT100 was 80x24. It is still used nowadays by
            // default in many terminal emulator. That's a good choice for a fallback
            // value.
            constexpr int fallback_width = 80;
            constexpr int fallback_height = 24;
#endif
            static Dimensions g_fallback_size
            {
                fallback_width,
                fallback_height,
            };
            return g_fallback_size;
        }

        const char* Safe(const char* c) 
        {
            return (c != nullptr) ? c : "";
        }

        bool Contains(const std::string& s, const char* key) 
        {
            return s.find(key) != std::string::npos;
        }

        Terminal::Colour ComputeColourSupport() 
        {
#if defined(__EMSCRIPTEN__)
            return Terminal::Colour::TrueColour;
#endif

            std::string COLORTERM = Safe(std::getenv("COLORTERM"));
            if (Contains(COLORTERM, "24bit") || Contains(COLORTERM, "truecolor")) 
            {
                return Terminal::Colour::TrueColour;
            }

            std::string TERM = Safe(std::getenv("TERM"));
            if (Contains(COLORTERM, "256") || Contains(TERM, "256")) 
            {
                return Terminal::Colour::Palette256;
            }

#if defined(FTXUI_MICROSOFT_TERMINAL_FALLBACK)
            // Microsoft terminals do not properly declare themselves supporting true
            // colors: https://github.com/microsoft/terminal/issues/1040
            // As a fallback, assume microsoft terminal are the ones not setting those
            // variables, and enable true colors.
            if (TERM.empty() && COLORTERM.empty()) 
            {
                return Terminal::Colour::TrueColor;
            }
#endif

            return Terminal::Colour::Palette16;
        }

    }//


    Dimensions Terminal::Size() 
    {
#if defined(__EMSCRIPTEN__)
        // This dimension was chosen arbitrarily to be able to display:
        // https://arthursonzogni.com/FTXUI/examples
        // This will have to be improved when someone has time to implement and need
        // it.
        return FallbackSize();
#elif defined(_WIN32)
        /*TODO: Move to platform implementation
        CONSOLE_SCREEN_BUFFER_INFO csbi;

        if (GetConsoleScreenBufferInfo(GetStdHandle(STD_OUTPUT_HANDLE), &csbi)) 
        {
            return Dimensions{csbi.srWindow.Right - csbi.srWindow.Left + 1,
            csbi.srWindow.Bottom - csbi.srWindow.Top + 1};
        }*/

        return FallbackSize();
#else
        winsize w{};
        const int status = ioctl(STDOUT_FILENO, TIOCGWINSZ, &w);
        // The ioctl return value result should be checked. Some operating systems
        // don't support TIOCGWINSZ.
        if (w.ws_col == 0 || w.ws_row == 0 || status < 0) 
        {
            return FallbackSize();
        }
        return Dimensions{w.ws_col, w.ws_row};
#endif
    }

    // Override terminal size in case auto-detection fails
    void Terminal::SetFallbackSize(const Dimensions& fallbackSize) 
    {
        FallbackSize() = fallbackSize;
    }

    // Get the colour support of the terminal.
    Terminal::Colour Terminal::ColourSupport() 
    {
        if (!g_cached) {
            g_cached = true;
            g_cached_supported_colour = ComputeColourSupport();
        }
        return g_cached_supported_colour;
    }

    // Override terminal colour support in case auto-detection fails
    void Terminal::SetColourSupport(Colour colour) 
    {
        g_cached = true;
        g_cached_supported_colour = colour;
    }

}}}//qor::components::tui