
// Copyright Querysoft Limited 2008 - 2025
//
// Permission is hereby granted, free of charge, to any person or organization
// obtaining a copy of the software and accompanying documentation covered by
// this license (the "Software") to use, reproduce, display, distribute,
// execute, and transmit the Software, and to prepare derivative works of the
// Software, and to permit third-parties to whom the Software is furnished to
// do so, all subject to the following:
// 
// The copyright notices in the Software and this entire statement, including
// the above license grant, this restriction and the following disclaimer,
// must be included in all copies of the Software, in whole or in part, and
// all derivative works of the Software, unless such copies or derivative
// works are solely in the form of machine-executable object code generated by
// a source language processor.
// 
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT
// SHALL THE COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE
// FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN CONTRACT, TORT OR OTHERWISE,
// ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
// DEALINGS IN THE SOFTWARE.

#ifndef QOR_PP_H_COMPONENTS_HTTP_FIELD_PARSER
#define QOR_PP_H_COMPONENTS_HTTP_FIELD_PARSER

#include <string>

#include "src/components/parser/state.h"
#include "src/components/parser/rfc5234.h"
#include "src/components/parser/tokens.h"
#include "src/components/parser/parser.h"
#include "src/components/parser/oneormore.h"

namespace qor { namespace components { namespace protocols { namespace http {

    enum class httpFieldToken : uint64_t    
    {
        obs_text = static_cast<uint64_t>(components::parser::eToken::Max) + 1ull,
        field_vchar,
        field_content,
        tchar,
        field,
        token,
    };

    static const std::map<const uint64_t, const std::string> httpFieldtokenNames = {{
        {static_cast< const uint64_t>(httpFieldToken::obs_text), "obs_text"},
        {static_cast< const uint64_t>(httpFieldToken::field_vchar), "field_vchar"},
        {static_cast< const uint64_t>(httpFieldToken::field_content), "field_content"},
        {static_cast< const uint64_t>(httpFieldToken::field_content), "tchar"},
        {static_cast< const uint64_t>(httpFieldToken::field_content), "field"},
        {static_cast< const uint64_t>(httpFieldToken::field_content), "token"},
    }};

    class qor_pp_module_interface(QOR_HTTP) obs_text : public components::parser::OneOfARange
    {
    public: obs_text(components::parser::Parser* parser) :
                components::parser::OneOfARange(parser, 0x80, 0xFF, static_cast<uint64_t>(httpFieldToken::obs_text))
            {}            
        virtual ~obs_text() = default;
        virtual void Emit();
    };

    class qor_pp_module_interface(QOR_HTTP) field_vchar : public components::parser::AnyOneOf
    {
    public: field_vchar(components::parser::Parser* parser) :
                components::parser::AnyOneOf(parser,
                    new_ref<components::parser::VCHAR>(parser).AsRef<components::parser::ParserState>(),
                    new_ref<obs_text>(parser).AsRef<components::parser::ParserState>(),
                    static_cast<uint64_t>(httpFieldToken::field_vchar))
            {}
        virtual ~field_vchar() = default;
        virtual void Emit();
    };

    class qor_pp_module_interface(QOR_HTTP) field_content : public components::parser::Sequence
    {
    public: field_content(components::parser::Parser* parser) :
                components::parser::Sequence(parser,
                    new_ref<field_vchar>(parser).AsRef<components::parser::ParserState>(),
                    new_ref<components::parser::ZeroOrMore>(parser,
                        new_ref<components::parser::Sequence>(parser,
                            new_ref<components::parser::Optional>(parser,
                                new_ref<components::parser::AnyOneOf>(parser,
                                    new_ref<components::parser::SP>(parser).AsRef<components::parser::ParserState>(),
                                    new_ref<components::parser::HTAB>(parser).AsRef<components::parser::ParserState>()
                                ).AsRef<components::parser::ParserState>()
                            ).AsRef<components::parser::ParserState>(),
                            new_ref<field_vchar>(parser).AsRef<components::parser::ParserState>()
                        ).AsRef<components::parser::ParserState>()
                    ).AsRef<components::parser::ParserState>(),
                    static_cast<uint64_t>(httpFieldToken::field_content))
            {}
        virtual ~field_content() = default;
        virtual void Prepare();
        virtual void Emit();
        virtual void Fail();
    };
    

    //"!" / "#" / "$" / "%" / "&" / "'" / "*" / "+" / "-" / "." / "^" / "_" / "`" / "|" / "~" / DIGIT / ALPHA
    class qor_pp_module_interface(QOR_HTTP) tchar : public components::parser::AnyOneOfSet
    {
    public: tchar(components::parser::Parser* parser) :
                components::parser::AnyOneOfSet(parser,
                    new std::vector<typename ref_of<components::parser::ParserState>::type > ({
                    new_ref<components::parser::Specific>(parser, '!').AsRef<components::parser::ParserState>(),
                    new_ref<components::parser::Specific>(parser, '#').AsRef<components::parser::ParserState>(),
                    new_ref<components::parser::Specific>(parser, '$').AsRef<components::parser::ParserState>(),
                    new_ref<components::parser::Specific>(parser, '%').AsRef<components::parser::ParserState>(),
                    new_ref<components::parser::Specific>(parser, '&').AsRef<components::parser::ParserState>(),
                    new_ref<components::parser::Specific>(parser, '\'').AsRef<components::parser::ParserState>(),
                    new_ref<components::parser::Specific>(parser, '*').AsRef<components::parser::ParserState>(),
                    new_ref<components::parser::Specific>(parser, '+').AsRef<components::parser::ParserState>(),
                    new_ref<components::parser::Specific>(parser, '-').AsRef<components::parser::ParserState>(),
                    new_ref<components::parser::Specific>(parser, '.').AsRef<components::parser::ParserState>(),
                    new_ref<components::parser::Specific>(parser, '^').AsRef<components::parser::ParserState>(),
                    new_ref<components::parser::Specific>(parser, '_').AsRef<components::parser::ParserState>(),
                    new_ref<components::parser::Specific>(parser, '`').AsRef<components::parser::ParserState>(),
                    new_ref<components::parser::Specific>(parser, '|').AsRef<components::parser::ParserState>(),
                    new_ref<components::parser::Specific>(parser, '~').AsRef<components::parser::ParserState>(),
                    new_ref<components::parser::DIGIT>(parser).AsRef<components::parser::ParserState>(),
                    new_ref<components::parser::ALPHA>(parser).AsRef<components::parser::ParserState>(),
                }),
                static_cast<uint64_t>(httpFieldToken::tchar))
            {}
        virtual ~tchar() = default;
        virtual void Emit();                  
    };

    class qor_pp_module_interface(QOR_HTTP) token : public components::parser::OneOrMore
    {
    public: token(components::parser::Parser* parser) :
                components::parser::OneOrMore( parser,
                    new_ref<tchar>(parser).AsRef<components::parser::ParserState>(),
                    static_cast<uint64_t>(httpFieldToken::token))
            {}

        virtual ~token() = default;
        virtual void Prepare();
        virtual void Emit();
        virtual void Fail();
    };

    class qor_pp_module_interface(QOR_HTTP) field : public components::parser::Sequence
    {
    public: field(components::parser::Parser* parser) :
                components::parser::Sequence( parser,
                    new_ref<token>(parser).AsRef<components::parser::ParserState>(),
                    new_ref<components::parser::Sequence>(parser,
                        new_ref<components::parser::Specific>(parser, ':').AsRef<components::parser::ParserState>(),
                        new_ref<field_content>(parser).AsRef<components::parser::ParserState>()
                    ).AsRef<components::parser::ParserState>(),
                    static_cast<uint64_t>(httpFieldToken::field))
            {}

        virtual ~field() = default;
        virtual void Prepare();
        virtual void Emit();
        virtual void Fail();
    };

}}}}//qor::components::protocols::http


#endif//QOR_PP_H_COMPONENTS_HTTP_FIELD_PARSER