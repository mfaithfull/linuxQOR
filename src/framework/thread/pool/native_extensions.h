// Copyright Querysoft Limited 2008 - 2025
//
// Permission is hereby granted, free of charge, to any person or organization
// obtaining a copy of the software and accompanying documentation covered by
// this license (the "Software") to use, reproduce, display, distribute,
// execute, and transmit the Software, and to prepare derivative works of the
// Software, and to permit third-parties to whom the Software is furnished to
// do so, all subject to the following:
// 
// The copyright notices in the Software and this entire statement, including
// the above license grant, this restriction and the following disclaimer,
// must be included in all copies of the Software, in whole or in part, and
// all derivative works of the Software, unless such copies or derivative
// works are solely in the form of machine-executable object code generated by
// a source language processor.
// 
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT
// SHALL THE COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE
// FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN CONTRACT, TORT OR OTHERWISE,
// ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
// DEALINGS IN THE SOFTWARE.

#ifndef QOR_PP_H_FRAMEWORK_THREADPOOL_NATIVEEXTENSIONS
#define QOR_PP_H_FRAMEWORK_THREADPOOL_NATIVEEXTENSIONS

#if     (qor_pp_os_target == qor_pp_os_windows)
#include "native_extensions_windows.h"
#elif   (qor_pp_os_target == qor_pp_os_linux)
#include "native_extensions_linux.h"
#else

//What's left was written for __APPLE__
#include <pthread.h>
#include <sched.h>
#include <sys/resource.h>
#include <unistd.h>

namespace qor { namespace framework{

    /**
     * @brief An enum containing pre-defined OS-specific process priority values for portability.
     */
    enum class os_process_priority
    {
        idle = PRIO_MAX - 2,
        below_normal = PRIO_MAX / 2,
        normal = 0,
        above_normal = PRIO_MIN / 3,
        high = PRIO_MIN * 2 / 3,
        realtime = PRIO_MIN
    };

    /**
     * @brief An enum containing pre-defined OS-specific thread priority values for portability.
     */
    enum class os_thread_priority
    {
        idle,
        lowest,
        below_normal,
        normal,
        above_normal,
        highest,
        realtime
    };


    /**
     * @brief Get the processor affinity of the current process using the current platform's native API. This should work on Windows and Linux, but is not possible on macOS as the native API does not allow it.
     *
     * @return An `std::optional` object, optionally containing the processor affinity of the current process as an `std::vector<bool>` where each element corresponds to a logical processor. If the returned object does not contain a value, then the affinity could not be determined. On macOS, this function always returns `std::nullopt`.
     */
    [[nodiscard]] inline std::optional<std::vector<bool>> get_os_process_affinity()
    {

        return std::nullopt;
    }

    /**
     * @brief Set the processor affinity of the current process using the current platform's native API. This should work on Windows and Linux, but is not possible on macOS as the native API does not allow it.
     *
     * @param affinity The processor affinity to set, as an `std::vector<bool>` where each element corresponds to a logical processor.
     * @return `true` if the affinity was set successfully, `false` otherwise. On macOS, this function always returns `false`.
     */
    inline bool set_os_process_affinity(const std::vector<bool>& affinity)
    {
        return affinity[0] && false; // NOLINT(readability-simplify-boolean-expr) // Using `affinity` to suppress unused parameter warning.
    }

    /**
     * @brief Get the priority of the current process using the current platform's native API. This should work on Windows, Linux, and macOS.
     *
     * @return An `std::optional` object, optionally containing the priority of the current process, as a member of the enum `os_process_priority`. If the returned object does not contain a value, then either the priority could not be determined, or it is not one of the pre-defined values and therefore cannot be represented in a portable way.
     */
    [[nodiscard]] inline std::optional<os_process_priority> get_os_process_priority()
    {
        // On Linux/macOS there is no direct analogue of `GetPriorityClass()` on Windows, so instead we get the "nice" value. The usual range is -20 to 19 or 20, with higher values corresponding to lower priorities. However, we are only using 6 pre-defined values for portability, so if the value was set via any means other than `set_os_process_priority()`, it may not match one of our pre-defined values. Note that `getpriority()` returns -1 on error, but since this does not correspond to any of our pre-defined values, this function will return `std::nullopt` anyway.
        const int nice_val = getpriority(PRIO_PROCESS, static_cast<id_t>(getpid()));
        switch (nice_val)
        {
        case static_cast<int>(os_process_priority::idle):
            return os_process_priority::idle;
        case static_cast<int>(os_process_priority::below_normal):
            return os_process_priority::below_normal;
        case static_cast<int>(os_process_priority::normal):
            return os_process_priority::normal;
        case static_cast<int>(os_process_priority::above_normal):
            return os_process_priority::above_normal;
        case static_cast<int>(os_process_priority::high):
            return os_process_priority::high;
        case static_cast<int>(os_process_priority::realtime):
            return os_process_priority::realtime;
        default:
            return std::nullopt;
        }
    }

    /**
     * @brief Set the priority of the current process using the current platform's native API. This should work on Windows, Linux, and macOS. However, note that higher priorities might require elevated permissions.
     *
     * @param priority The priority to set. Must be a value from the enum `os_process_priority`.
     * @return `true` if the priority was set successfully, `false` otherwise. Usually, `false` means that the user does not have the necessary permissions to set the desired priority.
     */
    inline bool set_os_process_priority(const os_process_priority priority)
    {
        // On Linux/macOS there is no direct analogue of `SetPriorityClass()` on Windows, so instead we set the "nice" value. The usual range is -20 to 19 or 20, with higher values corresponding to lower priorities. However, we are only using 6 pre-defined values for portability. Note that the "nice" values are only relevant for the `SCHED_OTHER` policy, but we do not set that policy here, as it is per-thread rather than per-process.
        // Also, it's important to note that a non-root user cannot decrease the nice value (i.e. increase the process priority), only increase it. This can cause confusing behavior. For example, if the current priority is `os_process_priority::normal` and the user sets it to `os_process_priority::idle`, they cannot change it back `os_process_priority::normal`.
        return setpriority(PRIO_PROCESS, static_cast<id_t>(getpid()), static_cast<int>(priority)) == 0;
    }

}}//qor::framework
#endif

#endif//QOR_PP_H_FRAMEWORK_THREADPOOL_NATIVEEXTENSIONS
